---
title: "Assignment 1"
author: "Aleksandra Dacko"
date: "9/28/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(magrittr)
library(here)
library(gridExtra)

options(dplyr.summarise.inform = FALSE)
```

```{r}
data<-read.csv(file="Data/ICAO_accidents.csv",header = T)
```

```{r}

head(data)
```


### In this part I would like to decode the missing name of the factors to Unknown or somthing more informative
```{r}
#to limit ourselves 
#remove to specific information and duplicates
data %<>% mutate("AircraftType"=case_when(Airplane=="True"~"Airplane",
                                     Helicopter=="True"~"Helicopter"),
                "WeightCat"=case_when(Over5700=="True"~">5700",
                                        Over2250=="False" ~ "<2250",
                                        Over2250=="True" & Over5700=="False" ~"2250-5700"),
                "RiskCat"=case_when(Risk %in% c("AMAN","MAC","CFIT","FUEL",'GTOW',"LOC-I","LOLI","LALT","UIMC")~"Airborne",
                                    Risk %in% c("F-NI","SCF-NP","SCF-PP","SCF")~"Aircraft" ,
                                    Risk %in% c("EVAC","F–POST","GCOL","RAMP","LOC–G","RE","RI–A","RI–VAP")~"Ground Operations",
                                    Risk %in% c("CABIN","EXTL","OTHR","OTH","SEC","GS","OD")~"Miscellaneous",
                                    Risk %in% c("Unknown","UNK","unk")~"Unknown/Undefined",
                                    Risk %in% c("RS")~"Runway Safety",
                                    Risk %in% c("BIRD","WILD")~"Wildlife",
                                    Risk %in% c("ADRM","ATM")~"Non-aircraft-related",
                                    Risk %in% c("ARC","CTOL","USOS")~"Takeoff and Landing",
                                    Risk %in% c("ICE","TURB","WSTRW","TUBR")~"Weather", #wrongly codded "TURB" spoted and added to the 
                                    Risk %in% c("MED")~"Injuries of Persons")) %>% mutate(RiskCat= replace_na(RiskCat, "Multiple") )%>% 
  select(!c("Location","Operator","Date","Model","StateOfOperator","Class","ScheduledCommercial","Official","OccCats","Over2250","Over5700","Helicopter","Airplane","Registration","X")) %>% mutate_if(is.character, as.factor) 


levels(data$Risk)[1]<-"Unknown"
levels(data$StateOfOccurrence)[1]<-"Unknown"
levels(data$StateOfRegistry)[1]<-"Unknown"
levels(data$FlightPhase)[1]<-"Unknown"
levels(data$InjuryLevel)[1]<-"Unknown"

str(data)


```

```{r}
#frequencies
data %$% table(AircraftType)

frq.per.country<-data %>% group_by(StateOfOccurrence) %>% 
  summarise(count=n()) %>% 
  arrange(.,desc(count))

frq.per.FlightPhase<-data %>% group_by(FlightPhase) %>% 
  summarise(count=n()) %>% 
  arrange(.,desc(count))

data %>% group_by(InjuryLevel) %>% 
  summarise(count=n()) %>% 
  arrange(.,desc(count))

data %>% group_by(Risk) %>% 
  summarise(count=n()) %>% 
  arrange(.,desc(count))



frq.flightPhase.by.InjuryLevel<-data %>% group_by(FlightPhase, InjuryLevel) %>% 
  summarise(count=n())

```


```{r}
#plots

# frequency of accidents by flight phase (Landing, Take-off, etc.) grouped by aircraft type (Airplane, Helicopter)
FlightPhase.order.ap<-data %>%subset(AircraftType=="Airplane") %>% group_by(FlightPhase) %>% 
  summarise(count=n()) %>% 
  arrange(.,count) %$% FlightPhase
FlightPhase.order.hel<-data %>%subset(AircraftType=="Helicopter") %>% group_by(FlightPhase) %>% 
  summarise(count=n()) %>% 
  arrange(.,count) %$% FlightPhase

data %>%subset(AircraftType=="Airplane") %>% ggplot( aes(x=factor(FlightPhase, FlightPhase.order.ap))) +
  geom_bar(aes(y = (..count..)/sum(..count..)))+
  coord_flip() +
  scale_y_continuous(labels=scales::percent,limits=c(0,0.40))+
  geom_text(aes( label = scales::percent((..count..)/sum(..count..)),
                   y= (..count..)/sum(..count..) ), stat= "count",hjust=-0.25) +
  labs(x = "Flight Phase", y="Percentage", title = "Airplane")+theme_minimal()
data %>%subset(AircraftType=="Helicopter") %>% ggplot( aes(x=factor(FlightPhase, FlightPhase.order.hel))) + 
  geom_bar(aes(y = (..count..)/sum(..count..)))+
  coord_flip() +
  scale_y_continuous(labels=scales::percent,limits=c(0,0.40))+
  geom_text(aes( label = scales::percent((..count..)/sum(..count..)),
                   y= (..count..)/sum(..count..) ), stat= "count", hjust =-0.25 ) +
  labs(x = "Flight Phase", y="Percentage",title = "Helicopter")+theme_minimal()

#checks of hte numbers -- correct 
subset(data, AircraftType=="Airplane" & FlightPhase=="Take-off") %>% nrow / subset(data, AircraftType=="Airplane") %>% nrow
subset(data, AircraftType=="Helicopter" & FlightPhase=="Take-off") %>% nrow / subset(data, AircraftType=="Helicopter") %>% nrow

```


```{r}
#order of the legend could be changed here is my proposition of a graph. The bad thing is that they are faced wraped but the frequencies are for whole dataset 
data %>% ggplot( aes(x=FlightPhase, fill=InjuryLevel)) + 
  geom_bar(aes(y = (..count..)/sum(..count..)),position = "dodge") +scale_y_continuous(labels=scales::percent)+facet_wrap(~AircraftType,scales = "free_y")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),panel.grid.major = element_line(colour = "grey"),panel.grid.minor = element_line(colour = "grey"),panel.grid.major.x = element_blank(),
  panel.grid.minor.x = element_blank()
, panel.background = element_blank())
```


```{r, echo=FALSE}
library(gridExtra)
library(grid)
grid_arrange_shared_legend <-
  function(...,
           ncol = length(list(...)),
           nrow = 1,
           position = c("bottom", "right")) {
    
    plots <- list(...)
    position <- match.arg(position)
    g <-
      ggplotGrob(plots[[1]] + theme(legend.position = position))$grobs
    legend <- g[[which(sapply(g, function(x)
      x$name) == "guide-box")]]
    lheight <- sum(legend$height)
    lwidth <- sum(legend$width)
    gl <- lapply(plots, function(x)
      x + theme(legend.position = "none"))
    gl <- c(gl, ncol = ncol, nrow = nrow)
    
    combined <- switch(
      position,
      "bottom" = arrangeGrob(
        do.call(arrangeGrob, gl),
        legend,
        ncol = 1,
        heights = unit.c(unit(1, "npc") - lheight, lheight)
      ),
      "right" = arrangeGrob(
        do.call(arrangeGrob, gl),
        legend,
        ncol = 2,
        widths = unit.c(unit(1, "npc") - lwidth, lwidth)
      )
    )
    
    grid.newpage()
    grid.draw(combined)
    
    # return gtable invisibly
    invisible(combined)
    
  }

```


```{r}
#number of accidents per year - trend
a<-data %>% group_by(Year,AircraftType) %>% 
  summarise(count=n()) %>% ggplot(aes(x=Year, y=count,color=AircraftType)) + 
  geom_line() + ggtitle("The accident count")+
  labs(x = "Year", y="Number of accidents")+theme_minimal()

#The fatal accidents per year-trend
c<-data %>% filter(Fatalities >0) %>% group_by(Year,AircraftType) %>% 
  summarise(count=n()) %>% ggplot(aes(x=Year, y=count,color=AircraftType)) + 
  geom_line() +
  labs(x = "Year", y="Count")+ ggtitle("The fatal accident count")+theme_minimal()
#death count per year- trend

b<-data %>% filter(Fatalities >0) %>% group_by(Year,AircraftType) %>% 
  summarise(sum=sum(Fatalities)) %>% ggplot(aes(x=Year, y=sum,color=AircraftType)) + 
  geom_line() +
  labs(x = "Year", y="Number of deaths")+ ggtitle("The total death count")+theme_minimal()
grid_arrange_shared_legend(a,b)
grid_arrange_shared_legend(a,c)

#theme(panel.background =element_rect("white"),panel.grid.major = element_line("grey87"),panel.grid.minor = element_line("grey87"),legend.background =element_rect("white"))
```
The classification of different risks has been done in such a way that is presented in the Attachment A https://www.icao.int/APAC/Meetings/2012_APRAST/OccurrenceCategoryDefinitions.pdf
In addition: 
* Note that we spoted wrongly coded "TURB"as "TUBR" and "UNK" as "unk" that we adjusted
* we added additional cathegory" Wildlife" since we had additional category "WILD" not appearing in the file
* For missing data and clasified as unknown we also created a separate category named "Unknown/Undefined"
* Since RS was not included in the report mention above we made a separate category out of it named "Runway Safety"
* If there was more than 1 accident reason defined we classified as "Multiple" category
```{r}

#risks involved in the accidents in more being a cause of at least 10 accidents
data%>% group_by(RiskCat) %>% summarise(count=n())%>% arrange(.,desc(count))

#most popular risks associated with fertality 
data %>% filter(Fatalities >0) %>% group_by(RiskCat) %>% summarise(count=n())%>% arrange(.,desc(count))

```
```{r}
Risk_ord_fat<-data %>%filter(Fatalities >0) %>%  group_by(RiskCat) %>% 
  summarise(count=n()) %>% 
  arrange(.,count) %$% RiskCat

data %>% filter(Fatalities >0) %>%  ggplot(aes(x=factor(RiskCat,Risk_ord_fat),fill=AircraftType))+ geom_bar(width=0.6)+ coord_flip()+facet_wrap(~AircraftType,scales = "free")+
  theme(legend.position = "",panel.background =element_rect("white"),panel.grid.major = element_line("grey87"),panel.grid.minor = element_line("grey87"),legend.background =element_rect("white"))+ggtitle("Risks involved in fatal accident occurance")+xlab("")+ylab("Number of accidents")


Risk_ord<-data %>%  group_by(RiskCat) %>% 
  summarise(count=n()) %>% 
  arrange(.,count) %$% RiskCat

data %>%  ggplot(aes(x=factor(RiskCat,Risk_ord),fill=AircraftType))+ geom_bar(width=0.6)+ coord_flip()+facet_wrap(~AircraftType,scales = "free")+
  theme(legend.position = "",panel.background =element_rect("white"),panel.grid.major = element_line("grey87"),panel.grid.minor = element_line("grey87"),legend.background =element_rect("white"))+ggtitle("Risks involved in accident occurance")+xlab("")+ylab("Number of accidents")

```


## My research questions 
### How many people died “depending on some factors” or over time? (I would not include helicopters, since they only can carry a few people in them)

```{r}
#distribution of number of engines
table<-data %>%subset(AircraftType=="Airplane" & InjuryLevel=="Fatal") %$% table(Engines) %>% transform() %>% rename("Count" ="Freq" )
table
#since only one with 6 engines I checked how many people died (15) we can directly report where it happened and we wont include it in the next graph
data %>%subset(AircraftType=="Airplane" & InjuryLevel=="Fatal") %>% group_by(Engines) %>% summarise(sum(Fatalities,na.rm = T))

```

```{r}
#since there was only one plane with 6 engenes I droped it and 
data %>%subset(AircraftType=="Airplane" & Fatalities>0 ) %>% ggplot(aes(x=as.factor(Engines),y=Fatalities))+geom_boxplot()+geom_jitter()+theme_minimal() 
data %>%subset(AircraftType=="Airplane" & Fatalities>0) %>% ggplot(aes(x=as.factor(RiskCat),y=Fatalities))+geom_boxplot()+geom_jitter()+coord_flip()+theme_minimal() 

data %>%subset(AircraftType=="Airplane" & Fatalities>0) %>% group_by(Year,EngineType) %>% 
  summarise(count=n()) %>% ggplot(aes(x=Year, y=count,color=EngineType)) + 
  geom_line() +
  labs(x = "Year", y="Count")+ ggtitle("The fatal accident count")+theme_minimal() 


```


# What changed in 2010 
```{r, warning=FALSE}
data %>% subset(Year %in% c("2010","2011","2012")) %>% ggplot(aes(x=Engines, group=Year))+geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count")+
  geom_text(aes( label = scales::percent(..prop..,accuracy = 0.1),
                   y= ..prop.. ), stat= "count", vjust = -.5) +theme(legend.position = "",panel.background =element_rect("white"),panel.grid.major = element_line("grey87"),panel.grid.minor = element_line("grey87"),legend.background =element_rect("white"))+facet_wrap(~Year)

data %>% subset(Year %in% c("2010","2011","2012")) %>% ggplot(aes(x=FlightPhase, group=Year))+geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count")+
  geom_text(aes( label = scales::percent(..prop..,accuracy = 0.1),
                   y= ..prop.. ), stat= "count", hjust = -0.3)+coord_flip()+theme(legend.position = "",panel.background =element_rect("white"),panel.grid.major = element_line("grey87"),panel.grid.minor = element_line("grey87"),legend.background =element_rect("white"))+ylim(c(0,0.45))+ facet_wrap(~Year)

data %>% subset(Year %in% c("2010","2011","2012")) %>% filter(Engines<6) %>% ggplot(aes(x=EngineType, group=Year))+geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count")+
  geom_text(aes( label = scales::percent(..prop..,accuracy = 0.1),
                   y= ..prop.. ), stat= "count", vjust = -.5) +theme(legend.position = "",panel.background =element_rect("white"),panel.grid.major = element_line("grey87"),panel.grid.minor = element_line("grey87"),legend.background =element_rect("white"))+facet_wrap(~Year+Engines,ncol = 4)

data %>% subset(Year %in% c("2010","2011","2012")) %>% ggplot(aes(x=WeightCat, group=Year))+geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count")+
  geom_text(aes( label = scales::percent(..prop..,accuracy = 0.1),
                   y= ..prop.. ), stat= "count", vjust = -.5) +theme(legend.position = "",panel.background =element_rect("white"),panel.grid.major = element_line("grey87"),panel.grid.minor = element_line("grey87"),legend.background =element_rect("white"))+facet_wrap(~Year)

data %>% subset(Year %in% c("2009","2010","2011","2012","2013","2014")) %>% ggplot(aes(x=InjuryLevel, group=Year))+geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count",width=0.6)+
  geom_text(aes( label = scales::percent(..prop..,accuracy = 1),
                   y= ..prop.. ), stat= "count", vjust = -.5) +theme(legend.position = "",panel.background =element_rect("white"),panel.grid.major = element_line("grey87"),panel.grid.minor = element_line("grey87"),legend.background =element_rect("white"))+facet_wrap(~Year)+ylim(c(0,0.65))

data %>%subset(AircraftType=="Airplane" ) %>% group_by(Year,EngineType) %>% 
  summarise(count=n()) %>% ggplot(aes(x=Year, y=count,color=EngineType)) + 
  geom_line() +
  labs(x = "Year", y="Count")+ ggtitle("The  accident count")+theme_minimal() 

data %>%subset(AircraftType=="Airplane" ) %>% group_by(Year,Engines) %>% 
  summarise(count=n()) %>% ggplot(aes(x=Year, y=count,color=as.factor(Engines))) + 
  geom_line() +
  labs(x = "Year", y="Count")+ ggtitle("The  accident count")+theme_minimal() 

data %>%filter(AircraftType=="Airplane" , EngineType=="Piston") %>% group_by(Year,Engines) %>% 
  summarise(count=n()) %>% ggplot(aes(x=Year, y=count,color=as.factor(Engines))) + 
  geom_line() +
  labs(x = "Year", y="Count")+ ggtitle("The Piston type of engine accident count")+theme_minimal() 

```













