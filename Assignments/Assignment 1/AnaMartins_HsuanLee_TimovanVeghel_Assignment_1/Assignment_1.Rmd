---
title: "Assignment1 - RHAT"
output: html_document
date: "September 2022"
---

# NYC Rat Sightings

## Data Description

The NYC Rat Sightings dataset describes mostly the location where there are rat sightings, the dates when it happened and which type of building it happened on. In the original dataset there are also many empty columns or columns with only one value, which just means the data was organised poorly, and we will not use these.

We will analyse if sightings depend on the month they happen. Additionally, we will analyse a dataset that describes borough populations so we can analyse if population density compares to number of rat sightings and which boroughs have more density of rat sightings. 

The dataset we will be using can be found on [kaggle](https://www.kaggle.com/datasets/new-york-city/nyc-rat-sightings).

```{r}
library(tidyverse)
```

## Data cleaning

First, we create a function to use for splitting up the different dates.

```{r}
date.split <- function(txtdate, x){
  date <- parse_date(txtdate, format = "%m/%d/%Y %I:%M:%S %p")
  time <- parse_time(txtdate, format = "%m/%d/%Y %I:%M:%S %p")
  year <- as.numeric(format(date, format = "%Y"))
  month <- as.numeric(format(date, format = "%m"))
  day <- as.numeric(format(date, format = "%d"))
  
  if (x == 1) {value <- year}
  else if (x == 2) {value <- month}
  else if (x == 3) {value <- day}
  else if (x == 4) {value <- time}
  
  return(value)
}
```


Secondly, we create a function to use when splitting a specific number from a data point, as used for both the address and the community boards.

```{r}
get.number <- function(string1, string2){
  
  split_1 <- strsplit(string1, split = " ")
  split_2 <- strsplit(string2, split = " ")
  
  unique_values <- Map(setdiff, split_1, split_2)
  to_be_returned <- unlist(unique_values)
  return(to_be_returned)
}
```

```{r}
#Second attempt at a function that could split "Incident_Address":
get.number2 <- function(address){
  if(!identical(address, NA)){
    nums <- str_extract(address, "[0-9]+")
    return(nums)
  }
}
```

The dataset initially looks like this:

```{r}
rat_dataset <-
  read_csv("Rat_Sightings.csv", show_col_types = FALSE)
head(rat_dataset)
```

with many empty features or with one single value. In this next step, we will be taking these features out and separating some interesting data in more features:

```{r}
rat_dataset <-
  read_csv("Rat_Sightings.csv", show_col_types = FALSE) %>% 
  #select("Unique Key", "Created Date", "Closed Date", "Location Type", "Incident Zip", "Incident Address", "Street Name", "Cross Street 1", "Cross Street 2", "Intersection Street 1", "Intersection Street 2", "Address Type", "Status", "Due Date", "Resolution Action Updated Date", "Community Board", "Borough", "Latitude", "Longitude") %>% 
  rename(Unique_Key = "Unique Key", Created_Date = "Created Date", Closed_Date = "Closed Date", Location_Type = "Location Type", Incident_Zip = "Incident Zip", Incident_Address = "Incident Address", Street_Name = "Street Name", Cross_Street_1 = "Cross Street 1", Cross_Street_2 = "Cross Street 2", Intersection_Street_1 = "Intersection Street 1", Intersection_Street_2 = "Intersection Street 2", Address_Type = "Address Type", Status = "Status", Due_Date = "Due Date", RAU_Date = "Resolution Action Updated Date", Community_Board = "Community Board", Borough = "Borough", Latitude = "Latitude", Longitude = "Longitude") %>% 
  mutate(Created_Year = date.split(Created_Date, 1), Created_Month = date.split(Created_Date, 2), Created_Day = date.split(Created_Date, 3)) %>% 
  mutate(Closed_Year = date.split(Closed_Date, 1), Closed_Month = date.split(Closed_Date, 2), Closed_Day = date.split(Closed_Date, 3)) %>%
  mutate(Due_Year = date.split(Due_Date, 1), Due_Month = date.split(Due_Date, 2), Due_Day = date.split(Due_Date, 3), Due_Time = date.split(Due_Date, 4)) %>%
  mutate(RAU_Year = date.split(RAU_Date, 1), RAU_Month = date.split(RAU_Date, 2), RAU_Day = date.split(RAU_Date, 3), RAU_Time = date.split(RAU_Date, 4)) %>% 
  ##These two lines handled the NAs in both columns, specifically to fit the get.number function
  #mutate(Incident_Address = replace_na(Incident_Address, "None")) %>% 
  #mutate(Street_Name = replace_na(Street_Name, "None")) %>% 
  mutate(Address_Number = get.number2(Incident_Address)) %>% 
  mutate(Community_Board_Number = get.number(Community_Board, Borough)) %>% 
  select(Unique_Key, Created_Year, Created_Month, Created_Day, Closed_Year, Closed_Month, Closed_Day, Location_Type, Incident_Zip, Address_Number, Street_Name, Cross_Street_1, Cross_Street_2, Intersection_Street_1, Intersection_Street_2, Address_Type, Status, Due_Year, Due_Month, Due_Day, Due_Time, RAU_Year, RAU_Month, RAU_Day, RAU_Time, Community_Board_Number, Borough, Latitude, Longitude)
```

We also want to make sure that all of the features have the proper value type.

```{r}
rat_dataset$Location_Type <- 
  as.factor(rat_dataset$Location_Type)
rat_dataset$Street_Name <-
  as.factor(rat_dataset$Street_Name)
rat_dataset$Cross_Street_1 <-
  as.factor(rat_dataset$Cross_Street_1)
rat_dataset$Cross_Street_2 <-
  as.factor(rat_dataset$Cross_Street_2)
rat_dataset$Address_Type <-
  as.factor(rat_dataset$Address_Type)
rat_dataset$Status <-
  as.factor(rat_dataset$Status)
rat_dataset$Borough <-
  as.factor(rat_dataset$Borough)
```


So, our starting point data is:

```{r}
head(rat_dataset)
summary(rat_dataset)
```

## Where are the sightings more concentrated?

To answer this question, we will import an extension of the `ggplot2` library, the `ggmap` library. If you don't have the `ggmap` package installed, please do so by running `install.packages("ggmap")` on your R console. 

```{r}
library("ggmap")
```

```{r}
KEY = 
register_google(key = KEY)
```


```{r}
ggplot(rat_dataset, mapping = aes(y = Longitude)) +
  geom_boxplot()
ggplot(rat_dataset, mapping = aes(y = Latitude)) +
  geom_boxplot()
```


Next, we choose the map we want to use:

```{r}
data4lat <-
  rat_dataset %>% 
  select(Latitude) %>% 
  filter(!is.na(Latitude))

max_lat <- max(data4lat)
min_lat <- min(data4lat)

data4lon <-
  rat_dataset %>% 
  select(Longitude) %>% 
  filter(!is.na(Longitude))

max_lon <- max(data4lon)
min_lon <- min(data4lon)

newyork.map <- get_map(location= 'New York')
sightings_map <-
  ggmap(newyork.map) +
  geom_point(data = rat_dataset, mapping = aes(x = Longitude, y = Latitude), alpha = 0.1) +
  stat_density2d(data = rat_dataset, mapping = aes(x=Longitude, y=Latitude)) +
  ylim(min_lat, max_lat) +
  xlim(min_lon, max_lon)
sightings_map
```

```{r}
location_map <-
  ggmap(newyork.map) +
  geom_point(data = filter(rat_dataset, Latitude, Longitude, Location_Type %in% c("1-2 Family Dwelling", "3+ Family Mixed Use Building")), mapping = aes(x = Longitude, y = Latitude, color = Location_Type), alpha = 0.1) +
  facet_wrap(~ Location_Type)

location_map
```


## Location Type and Rat number

```{r}
unique(rat_dataset$Location_Type)
# 20 location types
```

```{r}
# create the proportion for each location type
loc_per <- rat_dataset %>%
  group_by(Location_Type) %>%
  summarise(Percentage = round(100*(n() / nrow(.)), 1))

loc_per
```

```{r, fig.width=10, fig.height=7}
# Plot the Pie Chart
loc_per %>%
  ggplot(aes(x = "", y = Percentage, fill = Location_Type)) +
  geom_bar(stat = "identity") +
  coord_polar("y", start = 0) +
  geom_text(aes(label = paste(Percentage, "%")),
            position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values=c("#EFC000FF", "#33658A", "#2F4858", "#F6AE2D", 
                             "#F26419", "#999999", "#0073C2FF", "#55DDE0", 
                             "#868686FF", "#CD534CFF", "#BE2A3E", "#EC754A",
                             "#EACF65", "#3C8D53", "#ebf2ff", "#009dd1",
                             "#ee7d00", "#45902c", "#e94067", "#002a54",
                             "black")) +
  theme_classic() +
  theme(plot.title = element_text(hjust=0.5),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  labs(x = "", y = "", title = "Percentage of Rat Sighting in Different Location Type",
       fill = "Location Type")
```

## Time and Rat number

```{r}
# month with rat sighting (number)
rat_dataset %>%
  ggplot(aes(x = Created_Month, fill = Created_Month)) +
  geom_bar() +
  geom_text(stat='count', aes(label=..count..), vjust=-1) +
  scale_fill_manual(values=c("#EFC000FF", "#33658A", "#2F4858", "#F6AE2D", 
                             "#F26419", "#999999", "#0073C2FF", "#55DDE0", 
                             "#868686FF", "#CD534CFF", "#BE2A3E", "#EC754A")) +
  ylim(0, 15000) +
  labs(x = "Month", y = "Total Number of Rat Sighting", 
       title = "Number of Rat Sighting Each Month", fill = "Month") +
  theme_minimal() +
  theme(plot.title = element_text(hjust=0.5))
```

```{r}
# month with rat sighting (percentage)
month_per <- rat_dataset %>%
  group_by(Created_Month) %>%
  summarise(Percentage = round(100*(n() / nrow(.)),1))

month_per
```

```{r, fig.width=10, fig.height=7}
month_per %>%
  ggplot(aes(x = "", y = Percentage, fill = Created_Month)) +
  geom_bar(stat = "identity") +
  coord_polar("y", start = 0) +
  geom_text(aes(label = paste(Percentage, "%")),
            position = position_stack(vjust = 0.5)) +
  scale_fill_manual(values=c("#EFC000FF", "#33658A", "#2F4858", "#F6AE2D", 
                             "#F26419", "#999999", "#0073C2FF", "#55DDE0", 
                             "#868686FF", "#CD534CFF", "#BE2A3E", "#EC754A")) +
  theme_classic() +
  theme(plot.title = element_text(hjust=0.5),
        axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank()) +
  labs(x = "", y = "", title = "Percentage of Rat Sighting in Each Month",
       fill = "Month")
```


```{r}
# Year with rat sighting (bar chart)
rat_dataset %>%
  ggplot(aes(x = Created_Year, fill = Created_Year)) +
  geom_bar() +
  geom_text(stat='count', aes(label=..count..), vjust=-1) +
  scale_fill_manual(values=c("#EFC000FF", "#33658A", "#2F4858", "#F6AE2D", 
                             "#F26419", "#999999", "#0073C2FF", "#55DDE0")) +
  ylim(0, 20000) +
  labs(x = "Year", y = "Total Number of Rat Sighting", 
       title = "Number of Rat Sighting 2010 - 2017", fill = "Year") +
  theme_minimal() +
  theme(plot.title = element_text(hjust=0.5))

```

```{r}
# Year with rat sighting (count)
year_count <- rat_dataset %>%
  group_by(Created_Year) %>%
  summarise(Number = n())

year_count
```

```{r}
# Year with rat sighting (count)
year_count %>%
  ggplot(aes(x = Created_Year, y = Number, group = 1)) +
  geom_point() +
  geom_line(color = "dark blue") +
  labs(x = "Year", y = "Number of Rat Sighting", 
       title = "Number of Rat Sighting 2010 - 2017", fill = "Year") +
  theme_minimal() +
  theme(plot.title = element_text(hjust=0.5))
```

## Is the number of rat sightings in a given borough proportional to its population?

```{r}
Borough_Rats <- 
  rat_dataset %>% 
  group_by(Borough, Created_Year) %>% 
  tally(sort = TRUE) %>% 
  pivot_wider(names_from = Created_Year, values_from = n) %>% 
  select(Borough, "2010") %>% 
  drop_na() #%>% 
  #add_row(Borough = "NYC TOTAL", "2010" = sum(Borough_Rats$`2010`))

head(Borough_Rats)


Borough_Population_2010 <- 
  read_csv("New_York_City_Population_by_Borough__1950_-_2040.csv", show_col_types = FALSE) %>% 
  select("Borough", "2010") %>% 
  mutate(Borough = toupper(Borough)) %>% 
  inner_join(Borough_Rats, by = "Borough") %>% 
  rename(Borough = "Borough", Population = "2010.x", Rat_Sightings = "2010.y") %>% 
  mutate(Sightings_Rate = round(((Rat_Sightings / Population) * 100000), digits = 2))
  

head(Borough_Population_2010)
```

